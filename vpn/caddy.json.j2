{
  "logging": {
    "logs": {
        "default": { "level": "DEBUG" },
    "tls":     { "level": "DEBUG" },

      "access": {
        "level": "INFO",
        "writer": {
          "output": "file",
          "filename": "/logs/access-caddy.log",
          "roll": true,
          "roll_size_mb": 1024,
          "roll_keep": 5,
          "roll_keep_days": 30
        }
      }
    }
  },
  "apps": {
    "layer4": {
      "servers": {
        "l4": {
          "listen": [":443"],
          "routes": [
            {
              "match": [ { "tls": { "sni": ["www.microsoft.com"] } } ],
              "handle": [
                { "handler": "proxy", "upstreams": [ { "dial": ["127.0.0.1:8443"] } ] }
              ]
            },
            {
              "handle": [
                { "handler": "proxy", "upstreams": [ { "dial": ["127.0.0.1:4443"] } ] }
              ]
            }
          ]
        }
      }
    },

    "http": {
      "servers": {
        "http_srv": {
          "listen": [":80"],
          "logs": { "logger_names": { "default": "access" } },
          "routes": [
            { "match": [ { "path": ["/.well-known/*"] } ], "handle": [ { "handler": "file_server", "root": "/var/www" } ] },
            { "handle": [ { "handler": "reverse_proxy", "upstreams": [ { "dial": "127.0.0.1:8003" } ] } ] }
          ]
        },

        "https_srv": {
          "listen": [":4443"],
          "logs": { "logger_names": { "default": "access" } },
          "tls_connection_policies": [
            {
              "protocol_min": "tls1.2",
              "protocol_max": "tls1.3",
              "cipher_suites": [
                "TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384",
                "TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256"
              ],
              "curves": ["x25519"]
            }
          ],
          "routes": [
            {
              "match": [ { "path": ["/node/metrics*"] } ],
              "handle": [
                {
                  "handler": "authentication",
                  "providers": {"http_basic": {
                      "realm": "metrics",
                      "accounts": [
                        { "username": "metrics", "password": "{{ metrics_pwd | password_hash('bcrypt') }}" }
                      ],
                      "hash": { "algorithm": "bcrypt" }
                    }
                  }
                },
                { "handler": "rewrite", "uri": "/metrics" },
                { "handler": "reverse_proxy", "upstreams": [ { "dial": "127.0.0.1:9100" } ] }
              ]
            },
            {
              "match": [ { "path": ["/hy2/metrics*"] } ],
              "handle": [
                {
                  "handler": "authentication",
                  "providers": {"http_basic": {
                      "realm": "metrics",
                      "accounts": [
                        { "username": "metrics", "password": "{{ metrics_pwd | password_hash('bcrypt') }}" }
                      ],
                      "hash": { "algorithm": "bcrypt" }
                    }
                  }
                },
                { "handler": "rewrite", "uri": "/metrics" },
                { "handler": "reverse_proxy", "upstreams": [ { "dial": "127.0.0.1:7979" } ] }
              ]
            },
            {
              "handle": [ { "handler": "reverse_proxy", "upstreams": [ { "dial": "127.0.0.1:8003" } ] } ] }
          ]
        }
      }
    },

    "tls": {
      "certificates": {
        "automate": ["{{ ansible_host }}"]
      },
      "automation": {
        "policies": [
          {
            "subjects": ["{{ ansible_host }}"],
            "issuers": [
              {
                "module": "acme",
                "email": "admin@{{ ansible_host }}"
              }
            ]
          }
        ]
      }
    }
  }
}
